<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangkok Trip Nov 2025</title>
    <meta name="description" content="Bangkok Itinerary for November 2025">
    
    <!-- å¼•å…¥ Tailwind CSS (æ¨£å¼åº«) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ FontAwesome (ç‚ºäº†æ°£è±¡åŠŸèƒ½) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700;900&family=Playfair+Display:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* å…¨åŸŸæ¨£å¼ */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.5s ease; /* èƒŒæ™¯åˆ‡æ›å‹•ç•« */
        }
        h1, h2, h3, .font-serif {
            font-family: 'Playfair Display', 'Noto Serif TC', serif;
        }
        
        /* è‡ªå®šç¾©æ²è»¸ */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(251, 191, 36, 0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(217, 119, 6, 0.5); border-radius: 20px; }
        
        /* å‹•ç•«æ•ˆæœ */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .scale-click:active { transform: scale(0.95); }

        /* --- æ°£è±¡åŠŸèƒ½å°ˆç”¨æ¨£å¼ --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #38bdf8;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden-el { display: none; opacity: 0; }
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-right: 6px;
            margin-bottom: 6px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        .tag:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .tag i { margin-right: 6px; }
        
        /* éš±è—æ°£è±¡éƒ¨åˆ†çš„æ°´å¹³æ²è»¸ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body id="main-body" class="bg-amber-50 min-h-screen pb-24 selection:bg-amber-200">

    <!-- Header Image Section (Only visible on non-weather tabs) -->
    <div id="main-header" class="relative w-full h-72 md:h-96 overflow-hidden shadow-2xl bg-gray-900 border-b-4 border-amber-400 group transition-all duration-500">
        <a href="https://www.google.com/maps/search/?api=1&query=Bangkok" target="_blank" class="block w-full h-full relative cursor-pointer" onclick="playSound()" title="é»æ“Šé–‹å•Ÿæ›¼è°·åœ°åœ–">
            <div class="absolute inset-0 flex items-center justify-center">
                <img 
                    id="header-img"
                    src="image.png" 
                    alt="Bangkok Trip DM" 
                    class="w-full h-full object-contain opacity-95 transition-transform duration-700 group-hover:scale-105"
                    onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1563492065599-3520f775eeed?q=80&w=1000&auto=format&fit=crop'; this.className='w-full h-full object-cover opacity-90';"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
            </div>
            
            <div class="absolute bottom-8 left-0 right-0 text-center px-4">
                <h1 class="text-3xl md:text-5xl font-serif font-bold leading-tight drop-shadow-lg text-amber-100 tracking-wider">
                    <span class="block text-sm md:text-base text-amber-300 uppercase tracking-[0.3em] mb-2 font-sans">Amazing Thailand</span>
                    Bangkok Trip
                    <span class="block text-xl md:text-3xl mt-2 text-amber-400">November 2025</span>
                </h1>
                <p class="mt-3 text-xs text-amber-200/60 font-sans tracking-widest flex items-center justify-center gap-1 group-hover:text-amber-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    é»æ“Šé–‹å•Ÿåœ°åœ–
                </p>
            </div>
        </a>
    </div>

    <!-- Navigation Tabs -->
    <div class="sticky top-0 z-50 bg-amber-50/95 backdrop-blur-md shadow-md border-b border-amber-200 transition-colors duration-500" id="nav-container">
        <div class="flex justify-center p-3 gap-2 md:gap-3 max-w-lg mx-auto overflow-x-auto">
            <button id="tab-1129" onclick="switchTab('11/29')" class="flex-1 py-2 px-3 rounded-xl font-serif font-bold text-sm md:text-lg transition-all duration-300 border-2 whitespace-nowrap bg-purple-900 border-amber-400 text-amber-100 shadow-lg shadow-purple-900/40 transform scale-105">
                11/29
            </button>
            <button id="tab-1130" onclick="switchTab('11/30')" class="flex-1 py-2 px-3 rounded-xl font-serif font-bold text-sm md:text-lg transition-all duration-300 border-2 whitespace-nowrap bg-white border-amber-100 text-amber-800 hover:bg-amber-100 hover:border-amber-300">
                11/30
            </button>
            <button id="tab-split" onclick="switchTab('split')" class="flex-1 py-2 px-3 rounded-xl font-serif font-bold text-sm md:text-lg transition-all duration-300 border-2 whitespace-nowrap bg-white border-amber-100 text-amber-800 hover:bg-amber-100 hover:border-amber-300 flex items-center justify-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="16" y1="18" x2="16" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="8" y1="18" x2="8" y2="18"/></svg>
                åˆ†å¸³
            </button>
            <button id="tab-weather" onclick="switchTab('weather')" class="flex-1 py-2 px-3 rounded-xl font-serif font-bold text-sm md:text-lg transition-all duration-300 border-2 whitespace-nowrap bg-white border-amber-100 text-amber-800 hover:bg-amber-100 hover:border-amber-300 flex items-center justify-center gap-1">
                <i class="fa-solid fa-cloud-sun"></i>
                æ°£è±¡
            </button>
        </div>
    </div>

    <!-- Container for Itinerary -->
    <div id="itinerary-view" class="max-w-2xl mx-auto px-4 mt-8 space-y-8"></div>

    <!-- Container for Split Bill -->
    <div id="split-view" class="hidden max-w-2xl mx-auto px-4 mt-8 space-y-6 pb-24">
        <!-- åˆ†å¸³ UI å…§å®¹ (èˆ‡ä¹‹å‰ç›¸åŒ) -->
        <div class="bg-white rounded-2xl shadow-md p-5 border border-amber-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-serif font-bold text-purple-900">åˆ†å¸³è¨­å®š</h3>
                <select id="currency-select" onchange="updateCurrency()" class="bg-amber-50 border border-amber-200 text-amber-900 text-sm rounded-lg block p-2">
                    <option value="THB">æ³°éŠ– (THB)</option>
                    <option value="TWD">å°å¹£ (TWD)</option>
                    <option value="JPY">æ—¥å¹£ (JPY)</option>
                    <option value="KRW">éŸ“å¹£ (KRW)</option>
                    <option value="USD">ç¾å…ƒ (USD)</option>
                    <option value="EUR">æ­å…ƒ (EUR)</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">æ–°å¢æˆå“¡</label>
                <div class="flex gap-2">
                    <input type="text" id="new-user-input" placeholder="è¼¸å…¥åå­—" class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5">
                    <button onclick="addUser()" class="text-white bg-purple-700 hover:bg-purple-800 font-medium rounded-lg text-sm px-5 py-2.5 scale-click">æ–°å¢</button>
                </div>
            </div>
            <div id="user-list" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-md p-5 border border-amber-100">
            <h3 class="text-xl font-serif font-bold text-purple-900 mb-4">æ–°å¢æ”¯å‡º</h3>
            <div class="grid grid-cols-1 gap-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-1">é …ç›®åç¨±</label><input type="text" id="expense-desc" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">é‡‘é¡</label><input type="number" id="expense-amount" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">èª°å…ˆå¢Šä»˜ (å¯è¤‡é¸)</label>
                    <div id="payer-selection-container" class="flex flex-wrap gap-2 p-2 bg-gray-50 rounded-lg border border-gray-200 min-h-[50px]"></div>
                </div>
                <button onclick="addExpense()" class="w-full text-white bg-amber-500 hover:bg-amber-600 font-bold rounded-lg text-sm px-5 py-3 mt-2 scale-click shadow-md">åŠ å…¥å¸³ç›®</button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-md p-5 border border-amber-100">
            <h3 class="text-xl font-serif font-bold text-purple-900 mb-4 flex items-center justify-between">
                æ”¯å‡ºæ˜ç´°
                <span id="total-amount-display" class="text-sm bg-amber-100 text-amber-800 py-1 px-3 rounded-full">ç¸½è¨ˆ: 0</span>
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-amber-50"><tr><th class="px-3 py-3 rounded-l-lg">é …ç›®</th><th class="px-3 py-3">ä»˜æ¬¾äºº</th><th class="px-3 py-3">é‡‘é¡</th><th class="px-3 py-3 rounded-r-lg text-right">æ“ä½œ</th></tr></thead>
                    <tbody id="expense-list-body"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-gradient-to-br from-purple-50 to-amber-50 rounded-2xl shadow-lg p-6 border border-purple-100">
            <h3 class="text-xl font-serif font-bold text-purple-900 mb-2">çµç®—çµæœ</h3>
            <div id="settlement-result" class="space-y-3"></div>
        </div>
    </div>

    <!-- Container for Weather (Hidden by default) -->
    <div id="weather-view" class="hidden w-full min-h-[calc(100vh-150px)] p-4 flex items-start justify-center pt-8">
        <!-- åµŒå…¥çš„å¤©æ°£æ¨¡çµ„ -->
        <div class="glass-panel w-full max-w-md rounded-[2rem] p-6 text-white relative overflow-hidden shadow-2xl">
            <!-- Header & Date -->
            <div class="text-center mb-6 z-10 relative">
                <h1 class="text-xl font-bold flex items-center justify-center gap-2">
                    <span id="locationName">åœ¨åœ°æ°£è±¡é¡§å•</span>
                </h1>
                <div id="dateDisplay" class="text-indigo-200 text-sm mt-1 font-medium tracking-wide"></div>
            </div>

            <!-- Button -->
            <div class="flex flex-col items-center gap-3 mb-6 relative z-10">
                <button id="getLocationBtn" onclick="startWeatherProcess()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3.5 px-6 rounded-2xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 border border-white/10">
                    <span id="btnText">åˆ†æä»Šæ—¥å¤©æ°£ & ç©¿æ­</span>
                    <span id="btnLoader" class="loader hidden-el"></span>
                </button>
                <p id="statusMsg" class="text-xs text-blue-200 min-h-[1.5rem] text-center"></p>
            </div>

            <!-- Result Container -->
            <div id="weatherResult" class="hidden-el flex flex-col gap-5 relative z-10">
                <!-- 1. Main Weather Card -->
                <div class="flex items-center justify-between bg-white/5 rounded-2xl p-5 border border-white/10 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-blue-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="relative z-10">
                        <div class="text-5xl font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-white to-blue-200" id="currentTemp">--Â°</div>
                        <div class="text-sm font-medium text-blue-300 mt-1 flex items-center gap-2">
                            <span id="weatherDesc">--</span>
                            <span class="text-xs text-slate-400">| é«”æ„Ÿ <span id="apparentTemp">--</span>Â°</span>
                        </div>
                    </div>
                    <div class="text-center relative z-10">
                        <i id="weatherIcon" class="fa-solid fa-cloud text-5xl text-blue-100 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]"></i>
                    </div>
                </div>

                <!-- 2. Smart Outfit Advice -->
                <div class="bg-gradient-to-br from-indigo-500/20 to-purple-500/20 rounded-2xl p-5 border border-white/10">
                    <h3 class="text-xs font-bold text-indigo-200 uppercase tracking-wider mb-3 flex items-center">
                        <i class="fa-solid fa-shirt mr-2"></i> å‡ºé–€ç©¿æ­å»ºè­°
                    </h3>
                    <div id="outfitTags" class="flex flex-wrap"></div>
                    <div id="outfitSummary" class="text-sm text-slate-200 mt-3 leading-relaxed font-light border-t border-white/10 pt-3"></div>
                </div>

                <!-- 3. Stats Grid -->
                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-white/5 rounded-xl p-2 py-3 flex flex-col items-center justify-center border border-white/5">
                        <i class="fa-solid fa-umbrella text-blue-400 mb-1 text-sm"></i>
                        <div class="text-xs text-slate-400">é™é›¨ç‡</div>
                        <div class="font-bold text-sm"><span id="rainProb">--</span>%</div>
                    </div>
                    <div class="bg-white/5 rounded-xl p-2 py-3 flex flex-col items-center justify-center border border-white/5">
                        <i class="fa-solid fa-wind text-gray-400 mb-1 text-sm"></i>
                        <div class="text-xs text-slate-400">é¢¨é€Ÿ</div>
                        <div class="font-bold text-sm"><span id="windSpeed">--</span> <span class="text-[10px]">km/h</span></div>
                    </div>
                    <div class="bg-white/5 rounded-xl p-2 py-3 flex flex-col items-center justify-center border border-white/5">
                        <i class="fa-solid fa-lungs text-green-400 mb-1 text-sm"></i>
                        <div class="text-xs text-slate-400">ç©ºæ°£</div>
                        <div class="font-bold text-sm" id="aqiText">--</div>
                    </div>
                </div>

                <!-- 4. Forecast Strip -->
                <div>
                    <div class="overflow-x-auto pb-2 scrollbar-hide">
                        <div class="flex gap-2" id="forecastContainer"></div>
                    </div>
                </div>
            </div>

            <div class="mt-4 text-center text-[10px] text-slate-600">
                Powered by Open-Meteo & AI Outfit Logic
            </div>
        </div>
    </div>

    <script>
        // --- é€šç”¨æ ¸å¿ƒé‚è¼¯ ---
        const icons = {
            clock: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
            navigation: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>`,
            camera: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>`,
            utensils: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>`,
            coffee: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>`,
            shopping: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>`,
            music: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>`,
            moon: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`,
            mapPin: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
            alert: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,
            check: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
            arrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>`
        };

        function playSound() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    const audioCtx = new AudioContext();
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.15);
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.15);
                }
            } catch (e) { console.error("Audio not supported"); }
        }

        // --- 1. è¡Œç¨‹è¡¨é‚è¼¯ ---
        const itineraryData = {
            '11/29': [
                { time: "09:00 - 09:30", title: "å´–å·®è’™ç©ºå¯º Wat Yai Chai Mongkhon", type: "culture", icon: "camera", location: "Wat Yai Chai Mongkhon Ayutthaya", desc: "å¤§åŸåºœæœ€å¤è€çš„å¯ºå»Ÿä¹‹ä¸€ï¼Œå¿…çœ‹å·¨å¤§è‡¥ä½›ã€‚" },
                { time: "09:45 - 10:30", title: "ç‘ªå“ˆæ³°å¯º Wat Mahathat", type: "culture", icon: "camera", location: "Wat Mahathat Ayutthaya", desc: "è‘—åçš„ã€Œæ¨¹ä¸­ä½›é ­ã€æ‰€åœ¨åœ°ã€‚" },
                { time: "10:40 - 11:45", title: "å·´èŠèˆ¹é¢ Palek Boat Noodles", type: "food", icon: "utensils", location: "Pa Lek Boat Noodle Ayutthaya", desc: "à¸à¹‹à¸§à¸¢à¹€à¸•à¸µà¹‹à¸¢à¸§à¹€à¸£à¸·à¸­à¸›à¹‰à¸²à¹€à¸¥à¹‡à¸à¹€à¸ˆà¹‰à¸²à¹€à¸à¹ˆà¸² - ç•¶åœ°è€å­—è™Ÿèˆ¹éºµã€‚" },
                { time: "12:30 - 13:00", title: "SYAMA Cafe", type: "cafe", icon: "coffee", location: "SYAMA AYUDHYA", desc: "æ²³ç•”æ™¯è§€å’–å•¡å»³ï¼Œé©åˆä¼‘æ¯æ‹ç…§ã€‚" },
                { time: "13:30 - 14:30", title: "Kung Phuean Praew", type: "food", icon: "utensils", location: "Kung Phuean Praew Ayutthaya", desc: "äº«å—å¤§åŸè‘—åçš„çƒ¤è¦æ–™ç†ã€‚" },
                { time: "15:00 - 17:00", title: "æŸ´ç“¦å¡”é‚£è˜­å¯º Wat Chaiwatthanaram", type: "culture", icon: "camera", location: "Wat Chaiwatthanaram Ayutthaya", desc: "ğŸ”¥ Dress Code: æ³°æœé«”é©—ã€‚å¤•é™½æœ€ç¾ï¼Œé…·ä¼¼å³å“¥çªŸã€‚" },
                { time: "17:00", title: "Back to Bangkok", type: "travel", icon: "navigation", location: "Bangkok", desc: "è¿”å›æ›¼è°·å¸‚å€ã€‚" },
                { time: "19:30 - 20:30", title: "Asiatique æ‘©å¤©è¼ªå¤œå¸‚", type: "nightlife", icon: "shopping", location: "Asiatique The Riverfront", desc: "é€›è¡—ã€æ‘©å¤©è¼ªã€‚æ¨è–¦ï¼šEN Gelato å†°æ·‡æ·‹ã€‚" },
                { time: "21:00 - 22:00", title: "Calypso Cabaret (å·²è¨‚)", type: "show", icon: "music", location: "Calypso Cabaret Asiatique", desc: "åŒ…å«é£²æ–™ã€‚ç¶“å…¸äººå¦–ç§€è¡¨æ¼”ã€‚" },
                { time: "23:00", title: "Le Du Kaan é«˜ç©ºé…’å§ (å·²è¨‚)", type: "nightlife", icon: "moon", location: "Le Du Kaan Bangkok", desc: "äº«å—æ›¼è°·å¤œæ™¯ï¼ŒçµæŸç¾å¥½çš„ä¸€å¤©ã€‚" }
            ],
            '11/30': [
                { time: "08:00 - 09:00", title: "é‚¢æ³°è®° Kopi Hya Tai Ke", type: "food", icon: "coffee", location: "Kopi Hya Tai Ke Sao Chingcha", desc: "à¹‚à¸à¸›à¸µà¹Šà¹€à¸®à¸µà¹‰à¸¢à¸°à¹„à¸–à¹ˆà¸à¸µà¹ˆ - å‚³çµ±æ³°å¼æ—©é¤ï¼Œé–‹å•Ÿè€åŸå€ä¹‹æ—…ã€‚" },
                { 
                    time: "09:20 - 12:00", title: "ä¸­åœ‹åŸ / Song Wat Rd æ¢ç´¢", type: "walk", icon: "mapPin", location: "Song Wat Road Bangkok", desc: "æ–‡é’æ•£ç­–è·¯ç·š",
                    subList: [ "Yaowarat Gate", "Wanjai Cafe House", "Beans Coffee (å¯å¤–å¸¶)", "Gu Long Bao (å¤é¾åŒ…: å’–å•¡+åŒ…å­)", "Tay Cafe (äººæ°£åº—)", "Play Art House (å°è—å»Š)", "Double Goose å£ç•« (å¿…æ‹)", "I Scream å†°æ·‡æ·‹", "Saan Song Wat (æ–°é–‹æ–‡é’åº—)", "Onest at SongWat (æœ¨è³ªç¾åº—)", "pink rabbit + Bob (å¾ˆç´…çš„è›‹ç³•åº—)", "FV local Thai dessert (æ³°å¼ç”œé»)", "Copenn (é¦™æ°›)", "Song Wat Coffee Roaster (çƒ˜è±†åº—)", "Urai Han Palo Braised Goose (ç±³å…¶æ—æ»·éµ)", "Weekend Market (æ²³é‚Šå¸‚é›†)", "Pak Khlong Talad èŠ±å¸‚ (çµ‚é»)", "KHIRI Thai tea (èŠ±å¸‚é™„è¿‘)" ]
                },
                { time: "12:30 - 13:00", title: "åˆé¤: Nai Mong Hoi Tod", type: "food", icon: "utensils", location: "Nai Mong Hoi Tod Bangkok", desc: "ç±³å…¶æ—æ¨è–¦èšµä»”ç…ï¼Œé…¥è„†å£æ„Ÿã€‚" },
                { time: "14:00 - 14:30", title: "Ann Guay Tiew Kua Gai", type: "food", icon: "utensils", location: "Ann Guay Tiew Kua Gai Bangkok", desc: "ç±³å…¶æ—æ¨è–¦ç²¿æ¢è€åº— (é›è‚‰ç‚’æ²³ç²‰)ã€‚" },
                { time: "15:00 - 17:00", title: "Central World å•†åœˆ", type: "shopping", icon: "shopping", location: "Central World Bangkok", desc: "é€›è¡—è¡Œç¨‹ã€‚é‡é»ï¼šUno cafe, Mith é¦™æ°´ã€‚" },
                { time: "17:30 - 20:00", title: "Central Park / KAEW BOUTIQUE", type: "relax", icon: "coffee", location: "Kaew Boutique Bangkok", desc: "é¦™è˜­è‘‰ç”œé»å°ˆè³£åº—ï¼Œäº«å—å‚æ™šæ™‚å…‰ã€‚" },
                { time: "20:30 - 21:30", title: "æ™šé¤: CHONTHONG Kaprow", type: "food", icon: "utensils", location: "Chonthong Kaprow Silom", desc: "à¸Šà¹‰à¸­à¸™à¸—à¸­à¸‡ à¸•à¹‰à¸™à¸•à¸³à¸£à¸±à¸šà¸à¸°à¹€à¸à¸£à¸²à¹„à¸—à¸¢ (Silomåˆ†åº—) - æ­£å®—æ³°å¼æ‰“æ‹‹è±¬ã€‚" }
            ]
        };

        let currentDay = '11/29';

        function renderItinerary() {
            const container = document.getElementById('itinerary-view');
            container.innerHTML = '';
            if (currentDay === 'split' || currentDay === 'weather') return;

            const items = itineraryData[currentDay];
            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `group relative bg-white/90 backdrop-blur-sm rounded-xl p-6 shadow-md border-l-4 border-l-amber-500 border-y border-r border-amber-100 hover:shadow-2xl hover:border-l-purple-600 transition-all duration-300 transform hover:-translate-y-1 fade-in`;
                card.style.animationDelay = `${index * 0.05}s`;
                
                // å­æ¸…å–® HTML
                let subListHTML = '';
                if (item.subList) {
                    const listItems = item.subList.map(sub => `<li class="flex items-start gap-3 text-sm text-gray-700 font-sans"><span class="text-purple-600 mt-1">âœ¦</span>${sub}</li>`).join('');
                    subListHTML = `<div class="bg-amber-50/50 rounded-lg p-4 mb-4 border border-amber-200 max-h-64 overflow-y-auto custom-scrollbar"><p class="text-xs font-bold text-amber-800 mb-3 uppercase tracking-widest border-b border-amber-200 pb-1">Hidden Gems</p><ul class="space-y-3">${listItems}</ul></div>`;
                }
                
                // Type Color
                let typeColor = 'bg-teal-50 text-teal-800 border-teal-200';
                switch (item.type) {
                    case 'food': typeColor = 'bg-orange-100 text-orange-700 border-orange-200'; break;
                    case 'culture': typeColor = 'bg-amber-100 text-amber-700 border-amber-200'; break;
                    case 'cafe': typeColor = 'bg-yellow-50 text-yellow-800 border-yellow-200'; break;
                    case 'nightlife': typeColor = 'bg-purple-100 text-purple-800 border-purple-200'; break;
                    case 'shopping': typeColor = 'bg-pink-50 text-pink-700 border-pink-200'; break;
                }

                card.innerHTML = `
                    <div class="absolute -top-3 left-6"><span class="bg-purple-900 text-amber-100 text-xs font-sans font-bold px-4 py-1.5 rounded-full shadow-md flex items-center gap-1 border border-amber-500">${icons.clock} ${item.time}</span></div>
                    <div class="flex gap-4 pt-3">
                        <div class="flex-shrink-0 w-14 h-14 rounded-xl flex items-center justify-center shadow-inner ${typeColor}">${icons[item.icon] || icons.mapPin}</div>
                        <div class="flex-1"><h3 class="font-serif font-bold text-xl text-gray-800 leading-tight mb-2 tracking-wide text-purple-950">${item.title}</h3>${item.desc ? `<p class="text-sm font-sans text-gray-600 mb-4 leading-relaxed">${item.desc}</p>` : ''}${subListHTML}</div>
                    </div>
                    <div class="mt-2 pt-4 border-t border-dashed border-amber-200 flex justify-end"><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}" target="_blank" rel="noopener noreferrer" onclick="playSound()" class="flex items-center gap-2 bg-amber-100 hover:bg-amber-200 text-amber-900 px-5 py-2.5 rounded-lg text-sm font-bold transition-colors active:scale-95 no-underline shadow-sm border border-amber-200"><span class="text-purple-700">${icons.navigation}</span><span class="font-sans">å°èˆª</span></a></div>
                `;
                container.appendChild(card);
            });

            if (currentDay === '11/30') renderChecklist(container);
            
            const endMarker = document.createElement('div');
            endMarker.className = "text-center py-10 opacity-60 fade-in";
            endMarker.style.animationDelay = "0.5s";
            endMarker.innerHTML = `<div class="flex items-center justify-center gap-2 mb-2"><span class="h-px w-12 bg-amber-300"></span><span class="text-amber-500 text-xl">âœ¤</span><span class="h-px w-12 bg-amber-300"></span></div><p class="text-xs font-serif text-amber-800 tracking-widest">End of ${currentDay}</p>`;
            container.appendChild(endMarker);
        }

        // --- 2. Checklist é‚è¼¯ ---
        const checklistData = [
            { id: 0, text: "æ”œå¸¶ 5000 å°å¹£", sub: "ç¾é‡‘å‚™ç”¨" },
            { id: 1, text: "è­·ç…§", sub: "Passport" },
            { id: 2, text: "æ·±è‰²è¡£æœå‚™è‘—", sub: "é€²å¯ºå»Ÿ/æ­£å¼å ´åˆ" },
            { id: 3, text: "è¡Œå‹•é›»æº", sub: "Power Bank" },
            { id: 4, text: "å……é›»å™¨", sub: "Charger" },
            { id: 5, text: "æ²æµ´ç›¥æ´—ç”¨å“", sub: "Toiletries" }
        ];
        let checkedItems = JSON.parse(localStorage.getItem('bangkok_trip_checklist_2025')) || {};

        function renderChecklist(container) {
            const checklistContainer = document.createElement('div');
            checklistContainer.className = "mt-8 bg-amber-100/80 rounded-xl p-6 border-2 border-amber-400 border-dashed relative overflow-hidden shadow-lg fade-in";
            const list = document.createElement('ul');
            list.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
            checklistData.forEach(item => {
                const isChecked = checkedItems[item.id];
                const li = document.createElement('li');
                li.className = `flex items-center gap-3 p-3 rounded-lg border shadow-sm cursor-pointer transition-all duration-300 select-none scale-click ${isChecked ? 'bg-green-50 border-green-200 shadow-inner' : 'bg-white/60 border-amber-200/50 hover:bg-white hover:shadow-md'}`;
                li.innerHTML = `
                    <div class="flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-300 ${isChecked ? 'bg-green-500 border-green-500 scale-110' : 'bg-transparent border-gray-400'}">${isChecked ? `<span class="text-white">${icons.check}</span>` : ''}</div>
                    <div><span class="block font-bold font-serif text-lg transition-all duration-300 ${isChecked ? 'text-green-800 line-through decoration-green-500/50 opacity-70' : 'text-amber-900'}">${item.text}</span><span class="block text-xs font-sans transition-colors ${isChecked ? 'text-green-600/70' : 'text-amber-600/80'}">${item.sub}</span></div>
                `;
                li.onclick = () => {
                    playSound();
                    if (checkedItems[item.id]) delete checkedItems[item.id]; else checkedItems[item.id] = true;
                    localStorage.setItem('bangkok_trip_checklist_2025', JSON.stringify(checkedItems));
                    renderItinerary(); // Re-render to update
                };
                list.appendChild(li);
            });
            checklistContainer.innerHTML = `<div class="flex items-center gap-3 mb-6 pb-4 border-b border-amber-300/50"><div class="bg-purple-900 text-white p-2.5 rounded-full shadow-md">${icons.alert}</div><div><h3 class="font-serif font-bold text-2xl text-purple-900">é‡é»æé†’</h3><p class="text-xs font-sans text-amber-700 uppercase tracking-widest">Important Checklist</p></div></div>`;
            checklistContainer.appendChild(list);
            container.appendChild(checklistContainer);
        }

        // --- 3. åˆ†å¸³ç³»çµ±é‚è¼¯ ---
        let splitData = JSON.parse(localStorage.getItem('bangkok_trip_split_data_v4')) || { currency: 'THB', users: [], expenses: [] };
        const currencySymbols = { 'THB': 'à¸¿', 'TWD': 'NT$', 'JPY': 'Â¥', 'KRW': 'â‚©', 'USD': '$', 'EUR': 'â‚¬' };
        let selectedPayers = [];

        function saveSplitData() { localStorage.setItem('bangkok_trip_split_data_v4', JSON.stringify(splitData)); renderSplitView(); }
        
        function renderSplitView() {
            document.getElementById('currency-select').value = splitData.currency;
            document.getElementById('user-list').innerHTML = splitData.users.map(u => `<div class="flex items-center gap-1 bg-purple-100 text-purple-800 text-sm font-medium px-3 py-1 rounded-full border border-purple-200">${u}<button onclick="removeUser('${u}')" class="ml-1 text-purple-400 hover:text-purple-600">Ã—</button></div>`).join('') || '<span class="text-gray-400 text-sm italic">å°šæœªæ–°å¢æˆå“¡</span>';
            renderPayerSelection();
            
            const symbol = currencySymbols[splitData.currency];
            let total = 0;
            document.getElementById('expense-list-body').innerHTML = splitData.expenses.length === 0 ? `<tr class="bg-white border-b"><td colspan="4" class="px-3 py-4 text-center text-gray-400">ç›®å‰æ²’æœ‰æ”¯å‡ºç´€éŒ„</td></tr>` : splitData.expenses.map((exp, idx) => {
                total += parseFloat(exp.amount);
                return `<tr class="bg-white border-b hover:bg-amber-50/50 transition-colors"><td class="px-3 py-3 font-medium text-gray-900">${exp.desc}</td><td class="px-3 py-3">${Array.isArray(exp.payers) ? exp.payers.join(', ') : exp.payer}</td><td class="px-3 py-3 font-mono">${symbol} ${exp.amount}</td><td class="px-3 py-3 text-right"><button onclick="removeExpense(${idx})" class="text-red-400 hover:text-red-600 p-1 hover:bg-red-50 rounded transition-colors">${icons.trash}</button></td></tr>`;
            }).join('');
            document.getElementById('total-amount-display').innerText = `ç¸½è¨ˆ: ${symbol} ${total}`;
            calculateSettlement();
        }

        function renderPayerSelection() {
            const container = document.getElementById('payer-selection-container');
            if (splitData.users.length === 0) { container.innerHTML = '<span class="text-gray-400 text-sm py-1">è«‹å…ˆæ–°å¢æˆå“¡</span>'; return; }
            container.innerHTML = splitData.users.map(u => `<button onclick="togglePayer('${u}')" class="px-4 py-2 rounded-full text-sm font-bold transition-all duration-200 border border-transparent shadow-sm scale-click ${selectedPayers.includes(u) ? 'bg-amber-500 text-white shadow-amber-500/30' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}">${u}</button>`).join('');
        }
        function togglePayer(name) { playSound(); selectedPayers.includes(name) ? selectedPayers = selectedPayers.filter(p => p !== name) : selectedPayers.push(name); renderPayerSelection(); }
        function updateCurrency() { splitData.currency = document.getElementById('currency-select').value; saveSplitData(); }
        function addUser() { const name = document.getElementById('new-user-input').value.trim(); if (name && !splitData.users.includes(name)) { splitData.users.push(name); document.getElementById('new-user-input').value = ''; saveSplitData(); playSound(); } else if (splitData.users.includes(name)) alert('æˆå“¡å·²å­˜åœ¨'); }
        function removeUser(name) { if (splitData.expenses.some(e => (Array.isArray(e.payers) ? e.payers.includes(name) : e.payer === name))) { if (!confirm(`æˆå“¡ ${name} æœ‰æ”¯å‡ºç´€éŒ„ï¼Œåˆªé™¤å°‡æœƒç§»é™¤ç›¸é—œå¸³ç›®ï¼Œç¢ºå®šå—ï¼Ÿ`)) return; splitData.expenses = splitData.expenses.filter(e => (Array.isArray(e.payers) ? !e.payers.includes(name) : e.payer !== name)); } splitData.users = splitData.users.filter(u => u !== name); selectedPayers = selectedPayers.filter(u => u !== name); saveSplitData(); }
        function addExpense() { const desc = document.getElementById('expense-desc').value.trim(); const amount = parseFloat(document.getElementById('expense-amount').value); if (!desc || isNaN(amount)) return alert('è«‹å®Œæ•´å¡«å¯«é …ç›®èˆ‡é‡‘é¡'); if (selectedPayers.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€ä½ä»˜æ¬¾äºº'); splitData.expenses.push({ desc, amount, payers: [...selectedPayers] }); document.getElementById('expense-desc').value = ''; document.getElementById('expense-amount').value = ''; selectedPayers = []; saveSplitData(); playSound(); }
        function removeExpense(index) { splitData.expenses.splice(index, 1); saveSplitData(); }
        function calculateSettlement() {
            const container = document.getElementById('settlement-result');
            const { users, expenses } = splitData;
            if (users.length < 2 || expenses.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 py-4">è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•çµç®—</div>'; return; }
            let balances = {}; users.forEach(u => balances[u] = 0);
            let totalSpent = 0;
            expenses.forEach(e => { const amt = parseFloat(e.amount); totalSpent += amt; const payers = Array.isArray(e.payers) ? e.payers : [e.payer]; payers.forEach(p => { if (balances[p] !== undefined) balances[p] += amt / payers.length; }); });
            const avg = totalSpent / users.length; users.forEach(u => balances[u] -= avg);
            let debtors = users.filter(u => balances[u] < -0.01).map(u => ({ name: u, amount: balances[u] })).sort((a, b) => a.amount - b.amount);
            let creditors = users.filter(u => balances[u] > 0.01).map(u => ({ name: u, amount: balances[u] })).sort((a, b) => b.amount - a.amount);
            let results = []; let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                let amount = Math.min(Math.abs(debtors[i].amount), creditors[j].amount);
                results.push({ from: debtors[i].name, to: creditors[j].name, amount });
                debtors[i].amount += amount; creditors[j].amount -= amount;
                if (Math.abs(debtors[i].amount) < 0.01) i++; if (creditors[j].amount < 0.01) j++;
            }
            container.innerHTML = results.length === 0 ? '<div class="text-center text-green-600 font-bold py-4">å¸³ç›®å·²å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³ï¼</div>' : results.map(r => `<div class="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border-l-4 border-green-400"><div class="flex items-center gap-2"><span class="font-bold text-gray-800">${r.from}</span><span class="text-gray-400 text-xs">${icons.arrowRight}</span><span class="font-bold text-gray-800">${r.to}</span></div><div class="font-bold text-green-600 font-mono">${currencySymbols[splitData.currency]} ${r.amount.toFixed(2)}</div></div>`).join('');
        }

        // --- 4. æ°£è±¡åŠŸèƒ½é‚è¼¯ ---
        const ui = {
            btn: document.getElementById('getLocationBtn'),
            btnText: document.getElementById('btnText'),
            loader: document.getElementById('btnLoader'),
            msg: document.getElementById('statusMsg'),
            result: document.getElementById('weatherResult'),
            locName: document.getElementById('locationName'),
            temp: document.getElementById('currentTemp'),
            apparent: document.getElementById('apparentTemp'),
            desc: document.getElementById('weatherDesc'),
            icon: document.getElementById('weatherIcon'),
            rain: document.getElementById('rainProb'),
            wind: document.getElementById('windSpeed'),
            aqi: document.getElementById('aqiText'),
            tags: document.getElementById('outfitTags'),
            summary: document.getElementById('outfitSummary'),
            forecast: document.getElementById('forecastContainer'),
            dateDisplay: document.getElementById('dateDisplay')
        };

        const weatherCodes = {
            0: {d:"æ™´æœ—", i:"fa-sun"}, 1: {d:"å¤šé›²æ™‚æ™´", i:"fa-cloud-sun"}, 2: {d:"å¤šé›²", i:"fa-cloud"}, 
            3: {d:"é™°å¤©", i:"fa-cloud"}, 45: {d:"éœ§", i:"fa-smog"}, 
            51: {d:"ç´°é›¨", i:"fa-cloud-rain"}, 61: {d:"å°é›¨", i:"fa-cloud-rain"}, 63: {d:"ä¸­é›¨", i:"fa-cloud-rain"}, 
            65: {d:"å¤§é›¨", i:"fa-cloud-showers-heavy"}, 80: {d:"é™£é›¨", i:"fa-cloud-sun-rain"}, 95: {d:"é›·é›¨", i:"fa-bolt"}
        };

        function setWeatherState(loading, msg) {
            ui.btn.disabled = loading;
            ui.btnText.textContent = loading ? "åˆ†ææ•¸æ“šä¸­..." : "é‡æ–°åˆ†æ";
            ui.loader.style.display = loading ? "inline-block" : "none";
            ui.msg.textContent = msg;
            if (loading) {
                ui.result.style.display = 'none';
                ui.result.classList.remove('fade-in');
            }
        }

        function playChime() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const now = ctx.currentTime;
            [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0, now + i*0.1);
                gain.gain.linearRampToValueAtTime(0.05, now + i*0.1 + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 1.2);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(now + i*0.1);
                osc.stop(now + i*0.1 + 1.5);
            });
        }

        function generateOutfitAdvice(temp, apparentTemp, rainProb, windSpeed, aqi, weatherCode) {
            let tags = [];
            let summary = "";
            if (apparentTemp >= 30) {
                tags.push({text: "çŸ­è¢–/ç„¡è¢–", icon: "fa-shirt", color: "text-orange-300"});
                tags.push({text: "é€æ°£æè³ª", icon: "fa-wind", color: "text-blue-200"});
                summary = "å¤©æ°£éå¸¸ç‚ç†±ï¼Œè«‹ç©¿è‘—è¼•è–„é€æ°£çš„è¡£ç‰©ï¼Œé¿å…ä¸­æš‘ã€‚";
            } else if (apparentTemp >= 25) {
                tags.push({text: "çŸ­è¢–", icon: "fa-shirt", color: "text-yellow-200"});
                tags.push({text: "è–„é˜²æ›¬", icon: "fa-sun", color: "text-orange-200"});
                summary = "å¤©æ°£æº«æš–èˆ’é©ï¼ŒçŸ­è¢–æ­é…ä¸€ä»¶è–„è¥¯è¡«æˆ–è–„å¤–å¥—å³å¯ã€‚";
            } else if (apparentTemp >= 20) {
                tags.push({text: "è–„é•·è¢–/ä¸ƒåˆ†è¢–", icon: "fa-user-tag", color: "text-green-200"});
                tags.push({text: "è–„å¤–å¥—", icon: "fa-layer-group", color: "text-green-200"});
                summary = "é«”æ„Ÿèˆ’é©å¾®æ¶¼ï¼Œå»ºè­°ç©¿è‘—è–„é•·è¢–ï¼Œæˆ–çŸ­è¢–å¤–æ­ä¸€ä»¶è–„å¤¾å…‹ã€‚";
            } else if (apparentTemp >= 15) {
                tags.push({text: "å¤¾å…‹/å¸½T", icon: "fa-vest", color: "text-blue-200"});
                tags.push({text: "é•·è¤²", icon: "fa-socks", color: "text-blue-200"});
                summary = "ç¨æœ‰æ¶¼æ„ï¼Œå»ºè­°ç©¿è‘—å¤§å­¸Tã€å¸½Tæˆ–å¤¾å…‹ï¼Œé¿å…è‘—æ¶¼ã€‚";
            } else {
                tags.push({text: "åšå¤–å¥—/ç¾½çµ¨", icon: "fa-snowflake", color: "text-blue-100"});
                tags.push({text: "åœå·¾", icon: "fa-scarf", color: "text-purple-200"});
                summary = "å¤©æ°£å¯’å†·ï¼Œè«‹å‹™å¿…åšå¥½ä¿æš–ï¼Œå»ºè­°ç©¿è‘—ä¿æš–å¤–å¥—èˆ‡åœå·¾ã€‚";
            }
            if (rainProb >= 40 || (weatherCode >= 50 && weatherCode <= 99)) {
                tags.push({text: "å‹™å¿…å¸¶å‚˜", icon: "fa-umbrella", color: "text-blue-400", important: true});
                summary += " é™é›¨æ©Ÿç‡é«˜ï¼Œå‡ºé–€è«‹è¨˜å¾—æ”œå¸¶é›¨å…·ã€‚";
            } else if (rainProb >= 20) {
                tags.push({text: "æ‘ºç–Šå‚˜å‚™ç”¨", icon: "fa-umbrella", color: "text-slate-300"});
            }
            if (windSpeed >= 20) tags.push({text: "é˜²é¢¨å¤–å¥—", icon: "fa-wind", color: "text-gray-300"});
            if (aqi > 100) {
                tags.push({text: "æˆ´å£ç½©", icon: "fa-mask-face", color: "text-red-400", important: true});
                summary += " ç©ºæ°£å“è³ªä¸ä½³ï¼Œæ•æ„Ÿæ—ç¾¤è«‹é…æˆ´å£ç½©ã€‚";
            }
            if (weatherCode <= 1 && apparentTemp > 20) tags.push({text: "å¢¨é¡/å¸½å­", icon: "fa-glasses", color: "text-yellow-400"});
            return { tags, summary };
        }

        async function startWeatherProcess() {
            setWeatherState(true, "æ­£åœ¨å®šä½ä¸¦ç²å–æ°£è±¡æ•¸æ“š...");
            if (!navigator.geolocation) {
                useIpFallback("ç€è¦½å™¨ä¸æ”¯æ´ GPSï¼Œä½¿ç”¨ IP å®šä½");
                return;
            }
            navigator.geolocation.getCurrentPosition(
                pos => fetchWeatherData(pos.coords.latitude, pos.coords.longitude),
                err => {
                    console.warn(err);
                    useIpFallback("GPS æ¬Šé™å—é˜»ï¼Œåˆ‡æ›è‡³ IP ç¶²è·¯å®šä½");
                },
                { timeout: 4000 }
            );
        }

        async function useIpFallback(msg) {
            ui.msg.textContent = msg;
            try {
                const r = await fetch('https://ipapi.co/json/');
                if(!r.ok) throw new Error();
                const d = await r.json();
                if(d.city) ui.locName.innerHTML = `<i class="fa-solid fa-location-dot text-blue-400"></i> ${d.city} <span class="text-xs text-slate-400">æ°£è±¡é¡§å•</span>`;
                fetchWeatherData(d.latitude, d.longitude);
            } catch(e) {
                setWeatherState(false, "å®šä½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
            }
        }

        async function fetchWeatherData(lat, lon) {
            try {
                const [wRes, aRes] = await Promise.all([
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation_probability,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code&timezone=auto`),
                    fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi`)
                ]);
                const wData = await wRes.json();
                const aData = await aRes.json();
                renderWeather(wData, aData);
                playChime();
                setWeatherState(false, "åˆ†æå®Œæˆ");
            } catch(e) {
                console.error(e);
                setWeatherState(false, "è³‡æ–™ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦");
            }
        }

        function renderWeather(w, a) {
            const cur = w.current;
            const aqiVal = a.current.us_aqi;
            ui.temp.textContent = Math.round(cur.temperature_2m) + "Â°";
            ui.apparent.textContent = Math.round(cur.apparent_temperature);
            ui.rain.textContent = cur.precipitation_probability ?? 0;
            ui.wind.textContent = cur.wind_speed_10m;
            
            const code = cur.weather_code;
            const info = weatherCodes[code] || {d:"æœªçŸ¥", i:"fa-question"};
            ui.desc.textContent = info.d;
            ui.icon.className = `fa-solid ${info.i} text-5xl text-blue-100 drop-shadow-lg`;

            let aqiStatus = "è‰¯å¥½";
            if(aqiVal > 50) aqiStatus = "æ™®é€š";
            if(aqiVal > 100) aqiStatus = "ä¸ä½³";
            ui.aqi.textContent = `${aqiVal} (${aqiStatus})`;
            ui.aqi.className = `font-bold text-sm ${aqiVal > 100 ? 'text-red-400' : 'text-green-400'}`;

            const advice = generateOutfitAdvice(cur.temperature_2m, cur.apparent_temperature, cur.precipitation_probability, cur.wind_speed_10m, aqiVal, code);
            ui.tags.innerHTML = advice.tags.map(t => `<span class="tag ${t.important ? 'bg-blue-500/40 border-blue-400' : ''} ${t.color}"><i class="fa-solid ${t.icon}"></i>${t.text}</span>`).join('');
            ui.summary.textContent = advice.summary;

            ui.forecast.innerHTML = '';
            const nowHour = new Date().getHours();
            let startIdx = 0;
            w.hourly.time.forEach((t, i) => { if(new Date(t).getHours() === nowHour) startIdx = i; });
            for(let i=startIdx+1; i<=startIdx+8; i++) {
                if(!w.hourly.time[i]) break;
                const t = new Date(w.hourly.time[i]);
                const hCode = w.hourly.weather_code[i];
                const hInfo = weatherCodes[hCode] || {i:"fa-question"};
                ui.forecast.innerHTML += `<div class="flex-shrink-0 w-14 flex flex-col items-center bg-white/5 rounded-lg p-2"><span class="text-[10px] text-slate-400">${t.getHours()}:00</span><i class="fa-solid ${hInfo.i} my-1 text-sm"></i><span class="text-xs font-bold">${Math.round(w.hourly.temperature_2m[i])}Â°</span></div>`;
            }

            ui.result.style.display = 'flex';
            void ui.result.offsetWidth;
            ui.result.classList.add('fade-in');
        }
        
        // åˆå§‹åŒ–æ—¥æœŸ
        (function initDate() {
            const now = new Date();
            ui.dateDisplay.textContent = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        })();

        // --- è¦–åœ–åˆ‡æ› ---
        function switchTab(day) {
            playSound();
            currentDay = day;
            
            const tabs = ['1129', '1130', 'split', 'weather'];
            const activeClass = "bg-purple-900 border-amber-400 text-amber-100 shadow-lg shadow-purple-900/40 transform scale-105";
            const inactiveClass = "bg-white border-amber-100 text-amber-800 hover:bg-amber-100 hover:border-amber-300";

            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (!btn) return;
                const isSelected = (t === 'split' && day === 'split') || (t === '1129' && day === '11/29') || (t === '1130' && day === '11/30') || (t === 'weather' && day === 'weather');
                let baseClass = "flex-1 py-2 px-3 rounded-xl font-serif font-bold text-sm md:text-lg transition-all duration-300 border-2 whitespace-nowrap";
                if (t === 'split' || t === 'weather') baseClass += " flex items-center justify-center gap-1";
                btn.className = `${baseClass} ${isSelected ? activeClass : inactiveClass}`;
            });

            const itineraryView = document.getElementById('itinerary-view');
            const splitView = document.getElementById('split-view');
            const weatherView = document.getElementById('weather-view');
            const mainHeader = document.getElementById('main-header');
            const mainBody = document.getElementById('main-body');
            const navContainer = document.getElementById('nav-container');

            // éš±è—æ‰€æœ‰
            itineraryView.style.display = 'none';
            splitView.style.display = 'none';
            weatherView.style.display = 'none';
            
            // æ¢å¾©é è¨­æ¨£å¼
            mainBody.className = "bg-amber-50 min-h-screen pb-24 selection:bg-amber-200";
            navContainer.className = "sticky top-0 z-50 bg-amber-50/95 backdrop-blur-md shadow-md border-b border-amber-200 transition-colors duration-500";

            if (day === 'split') {
                splitView.classList.remove('hidden');
                splitView.style.display = 'block';
                mainHeader.style.display = 'block'; // é¡¯ç¤ºåœ–ç‰‡
                renderSplitView();
            } else if (day === 'weather') {
                // æ°£è±¡æ¨¡å¼ç‰¹æ®Šæ¨£å¼
                weatherView.classList.remove('hidden');
                weatherView.style.display = 'flex';
                mainHeader.style.display = 'none'; // éš±è—åœ–ç‰‡ä»¥é¨°å‡ºç©ºé–“
                
                // æ”¹è®ŠèƒŒæ™¯ç‚ºæ·±è‰²æ¼¸å±¤
                mainBody.className = "min-h-screen pb-24 text-white";
                mainBody.style.background = "linear-gradient(135deg, #0f172a 0%, #334155 100%)";
                // æ”¹è®Šå°è¦½åˆ—æ¨£å¼ä»¥é…åˆæ·±è‰²
                navContainer.className = "sticky top-0 z-50 bg-slate-800/80 backdrop-blur-md shadow-md border-b border-slate-700 transition-colors duration-500";
            } else {
                itineraryView.style.display = 'block';
                mainHeader.style.display = 'block'; // é¡¯ç¤ºåœ–ç‰‡
                // æ¢å¾©èƒŒæ™¯
                mainBody.style.background = ""; 
                renderItinerary();
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            renderItinerary();
        };

    </script>
</body>
</html>

