<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangkok Trip Nov 2025</title>
    <meta name="description" content="Bangkok Itinerary for November 2025">
    
    <!-- å¼•å…¥ Tailwind CSS (æ¨£å¼åº«) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700;900&family=Playfair+Display:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            /* é˜²æ­¢ iOS é»æ“Šé«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }
        h1, h2, h3, .font-serif {
            font-family: 'Playfair Display', 'Noto Serif TC', serif;
        }
        /* è‡ªå®šç¾©æ²è»¸ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(251, 191, 36, 0.1); 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(217, 119, 6, 0.5); 
            border-radius: 20px;
        }
        /* å‹•ç•«æ•ˆæœ */
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .scale-click:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-amber-50 min-h-screen pb-20 selection:bg-amber-200">

    <!-- Header Image Section -->
    <div class="relative w-full h-72 md:h-96 overflow-hidden shadow-2xl bg-gray-900 border-b-4 border-amber-400 group">
        <a href="https://www.google.com/maps/search/?api=1&query=Bangkok" target="_blank" class="block w-full h-full relative cursor-pointer" onclick="playSound()" title="é»æ“Šé–‹å•Ÿæ›¼è°·åœ°åœ–">
            <div class="absolute inset-0 flex items-center justify-center">
                <img 
                    id="header-img"
                    src="image.png" 
                    alt="Bangkok Trip DM" 
                    class="w-full h-full object-contain opacity-95 transition-transform duration-700 group-hover:scale-105"
                    onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1563492065599-3520f775eeed?q=80&w=1000&auto=format&fit=crop'; this.className='w-full h-full object-cover opacity-90';"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
            </div>
            
            <div class="absolute bottom-8 left-0 right-0 text-center px-4">
                <h1 class="text-3xl md:text-5xl font-serif font-bold leading-tight drop-shadow-lg text-amber-100 tracking-wider">
                    <span class="block text-sm md:text-base text-amber-300 uppercase tracking-[0.3em] mb-2 font-sans">Amazing Thailand</span>
                    Bangkok Trip
                    <span class="block text-xl md:text-3xl mt-2 text-amber-400">November 2025</span>
                </h1>
                <p class="mt-3 text-xs text-amber-200/60 font-sans tracking-widest flex items-center justify-center gap-1 group-hover:text-amber-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    é»æ“Šé–‹å•Ÿåœ°åœ–
                </p>
            </div>
        </a>
    </div>

    <!-- Navigation Tabs -->
    <div class="sticky top-0 z-50 bg-amber-50/95 backdrop-blur-md shadow-md border-b border-amber-200">
        <div class="flex justify-center p-3 gap-3 max-w-lg mx-auto overflow-x-auto">
            <button id="tab-1129" onclick="switchTab('11/29')" class="flex-1 py-2 px-3 rounded-xl font-serif font-bold text-base md:text-lg transition-all duration-300 border-2 whitespace-nowrap bg-purple-900 border-amber-400 text-amber-100 shadow-lg shadow-purple-900/40 transform scale-105">
                11/29
            </button>
            <button id="tab-1130" onclick="switchTab('11/30')" class="flex-1 py-2 px-3 rounded-xl font-serif font-bold text-base md:text-lg transition-all duration-300 border-2 whitespace-nowrap bg-white border-amber-100 text-amber-800 hover:bg-amber-100 hover:border-amber-300">
                11/30
            </button>
            <button id="tab-split" onclick="switchTab('split')" class="flex-1 py-2 px-3 rounded-xl font-serif font-bold text-base md:text-lg transition-all duration-300 border-2 whitespace-nowrap bg-white border-amber-100 text-amber-800 hover:bg-amber-100 hover:border-amber-300 flex items-center justify-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="16" y1="18" x2="16" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="8" y1="18" x2="8" y2="18"/></svg>
                åˆ†å¸³
            </button>
        </div>
    </div>

    <!-- Container for Itinerary -->
    <div id="itinerary-view" class="max-w-2xl mx-auto px-4 mt-8 space-y-8"></div>

    <!-- Container for Split Bill -->
    <div id="split-view" class="hidden max-w-2xl mx-auto px-4 mt-8 space-y-6 pb-24">
        
        <!-- 1. Settings / Users -->
        <div class="bg-white rounded-2xl shadow-md p-5 border border-amber-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-serif font-bold text-purple-900">åˆ†å¸³è¨­å®š</h3>
                <select id="currency-select" onchange="updateCurrency()" class="bg-amber-50 border border-amber-200 text-amber-900 text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block p-2">
                    <option value="THB">æ³°éŠ– (THB)</option>
                    <option value="TWD">å°å¹£ (TWD)</option>
                    <option value="JPY">æ—¥å¹£ (JPY)</option>
                    <option value="KRW">éŸ“å¹£ (KRW)</option>
                    <option value="USD">ç¾å…ƒ (USD)</option>
                    <option value="EUR">æ­å…ƒ (EUR)</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">æ–°å¢æˆå“¡</label>
                <div class="flex gap-2">
                    <input type="text" id="new-user-input" placeholder="è¼¸å…¥åå­— (ä¾‹å¦‚: Tom)" class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5">
                    <button onclick="addUser()" class="text-white bg-purple-700 hover:bg-purple-800 focus:ring-4 focus:ring-purple-300 font-medium rounded-lg text-sm px-5 py-2.5 scale-click">æ–°å¢</button>
                </div>
            </div>
            
            <div id="user-list" class="flex flex-wrap gap-2">
                <!-- User tags will be injected here -->
            </div>
        </div>

        <!-- 2. Add Expense -->
        <div class="bg-white rounded-2xl shadow-md p-5 border border-amber-100">
            <h3 class="text-xl font-serif font-bold text-purple-900 mb-4">æ–°å¢æ”¯å‡º</h3>
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é …ç›®åç¨±</label>
                    <input type="text" id="expense-desc" placeholder="ä¾‹å¦‚: æ™šé¤ã€è¨ˆç¨‹è»Š" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é‡‘é¡</label>
                    <input type="number" id="expense-amount" placeholder="0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">èª°å…ˆå¢Šä»˜ (å¯è¤‡é¸)</label>
                    <div id="payer-selection-container" class="flex flex-wrap gap-2 p-2 bg-gray-50 rounded-lg border border-gray-200 min-h-[50px]">
                        <span class="text-gray-400 text-sm py-1">è«‹å…ˆæ–°å¢æˆå“¡</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">* é¸æ“‡å¤šäººæ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•å¹³åˆ†å¢Šä»˜é‡‘é¡</p>
                </div>
                <button onclick="addExpense()" class="w-full text-white bg-amber-500 hover:bg-amber-600 focus:ring-4 focus:ring-amber-300 font-bold rounded-lg text-sm px-5 py-3 mt-2 scale-click shadow-md">
                    åŠ å…¥å¸³ç›®
                </button>
            </div>
        </div>

        <!-- 3. Expense List -->
        <div class="bg-white rounded-2xl shadow-md p-5 border border-amber-100">
            <h3 class="text-xl font-serif font-bold text-purple-900 mb-4 flex items-center justify-between">
                æ”¯å‡ºæ˜ç´°
                <span id="total-amount-display" class="text-sm bg-amber-100 text-amber-800 py-1 px-3 rounded-full">ç¸½è¨ˆ: 0</span>
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-amber-50">
                        <tr>
                            <th scope="col" class="px-3 py-3 rounded-l-lg">é …ç›®</th>
                            <th scope="col" class="px-3 py-3">ä»˜æ¬¾äºº</th>
                            <th scope="col" class="px-3 py-3">é‡‘é¡</th>
                            <th scope="col" class="px-3 py-3 rounded-r-lg text-right">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="expense-list-body">
                        <!-- Expenses will be injected here -->
                        <tr class="bg-white border-b"><td colspan="4" class="px-3 py-4 text-center text-gray-400">ç›®å‰æ²’æœ‰æ”¯å‡ºç´€éŒ„</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 4. Settlement Result -->
        <div class="bg-gradient-to-br from-purple-50 to-amber-50 rounded-2xl shadow-lg p-6 border border-purple-100">
            <h3 class="text-xl font-serif font-bold text-purple-900 mb-2">çµç®—çµæœ</h3>
            <p class="text-sm text-gray-500 mb-4">ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—æ¯äººæ‡‰ä»˜é‡‘é¡ï¼Œä¸¦å»ºè­°æœ€ä½³è½‰å¸³æ–¹å¼ã€‚</p>
            
            <div id="settlement-result" class="space-y-3">
                <!-- Settlement items injected here -->
                <div class="text-center text-gray-400 py-4">è«‹å…ˆè¼¸å…¥æˆå“¡èˆ‡æ”¯å‡ºè³‡æ–™</div>
            </div>
        </div>

    </div>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™ ---
        const itineraryData = {
            '11/29': [
                { time: "09:00 - 09:30", title: "å´–å·®è’™ç©ºå¯º Wat Yai Chai Mongkhon", type: "culture", icon: "camera", location: "Wat Yai Chai Mongkhon Ayutthaya", desc: "å¤§åŸåºœæœ€å¤è€çš„å¯ºå»Ÿä¹‹ä¸€ï¼Œå¿…çœ‹å·¨å¤§è‡¥ä½›ã€‚" },
                { time: "09:45 - 10:30", title: "ç‘ªå“ˆæ³°å¯º Wat Mahathat", type: "culture", icon: "camera", location: "Wat Mahathat Ayutthaya", desc: "è‘—åçš„ã€Œæ¨¹ä¸­ä½›é ­ã€æ‰€åœ¨åœ°ã€‚" },
                { time: "10:40 - 11:45", title: "å·´èŠèˆ¹é¢ Palek Boat Noodles", type: "food", icon: "utensils", location: "Pa Lek Boat Noodle Ayutthaya", desc: "à¸à¹‹à¸§à¸¢à¹€à¸•à¸µà¹‹à¸¢à¸§à¹€à¸£à¸·à¸­à¸›à¹‰à¸²à¹€à¸¥à¹‡à¸à¹€à¸ˆà¹‰à¸²à¹€à¸à¹ˆà¸² - ç•¶åœ°è€å­—è™Ÿèˆ¹éºµã€‚" },
                { time: "12:30 - 13:00", title: "SYAMA Cafe", type: "cafe", icon: "coffee", location: "SYAMA AYUDHYA", desc: "æ²³ç•”æ™¯è§€å’–å•¡å»³ï¼Œé©åˆä¼‘æ¯æ‹ç…§ã€‚" },
                { time: "13:30 - 14:30", title: "Kung Phuean Praew", type: "food", icon: "utensils", location: "Kung Phuean Praew Ayutthaya", desc: "äº«å—å¤§åŸè‘—åçš„çƒ¤è¦æ–™ç†ã€‚" },
                { time: "15:00 - 17:00", title: "æŸ´ç“¦å¡”é‚£è˜­å¯º Wat Chaiwatthanaram", type: "culture", icon: "camera", location: "Wat Chaiwatthanaram Ayutthaya", desc: "ğŸ”¥ Dress Code: æ³°æœé«”é©—ã€‚å¤•é™½æœ€ç¾ï¼Œé…·ä¼¼å³å“¥çªŸã€‚" },
                { time: "17:00", title: "Back to Bangkok", type: "travel", icon: "navigation", location: "Bangkok", desc: "è¿”å›æ›¼è°·å¸‚å€ã€‚" },
                { time: "19:30 - 20:30", title: "Asiatique æ‘©å¤©è¼ªå¤œå¸‚", type: "nightlife", icon: "shopping", location: "Asiatique The Riverfront", desc: "é€›è¡—ã€æ‘©å¤©è¼ªã€‚æ¨è–¦ï¼šEN Gelato å†°æ·‡æ·‹ã€‚" },
                { time: "21:00 - 22:00", title: "Calypso Cabaret (å·²è¨‚)", type: "show", icon: "music", location: "Calypso Cabaret Asiatique", desc: "åŒ…å«é£²æ–™ã€‚ç¶“å…¸äººå¦–ç§€è¡¨æ¼”ã€‚" },
                { time: "23:00", title: "Le Du Kaan é«˜ç©ºé…’å§ (å·²è¨‚)", type: "nightlife", icon: "moon", location: "Le Du Kaan Bangkok", desc: "äº«å—æ›¼è°·å¤œæ™¯ï¼ŒçµæŸç¾å¥½çš„ä¸€å¤©ã€‚" }
            ],
            '11/30': [
                { time: "08:00 - 09:00", title: "é‚¢æ³°è®° Kopi Hya Tai Ke", type: "food", icon: "coffee", location: "Kopi Hya Tai Ke Sao Chingcha", desc: "à¹‚à¸à¸›à¸µà¹Šà¹€à¸®à¸µà¹‰à¸¢à¸°à¹„à¸–à¹ˆà¸à¸µà¹ˆ - å‚³çµ±æ³°å¼æ—©é¤ï¼Œé–‹å•Ÿè€åŸå€ä¹‹æ—…ã€‚" },
                { 
                    time: "09:20 - 12:00", title: "ä¸­åœ‹åŸ / Song Wat Rd æ¢ç´¢", type: "walk", icon: "mapPin", location: "Song Wat Road Bangkok", desc: "æ–‡é’æ•£ç­–è·¯ç·š",
                    subList: [ "Yaowarat Gate", "Wanjai Cafe House", "Beans Coffee (å¯å¤–å¸¶)", "Gu Long Bao (å¤é¾åŒ…: å’–å•¡+åŒ…å­)", "Tay Cafe (äººæ°£åº—)", "Play Art House (å°è—å»Š)", "Double Goose å£ç•« (å¿…æ‹)", "I Scream å†°æ·‡æ·‹", "Saan Song Wat (æ–°é–‹æ–‡é’åº—)", "Onest at SongWat (æœ¨è³ªç¾åº—)", "pink rabbit + Bob (å¾ˆç´…çš„è›‹ç³•åº—)", "FV local Thai dessert (æ³°å¼ç”œé»)", "Copenn (é¦™æ°›)", "Song Wat Coffee Roaster (çƒ˜è±†åº—)", "Urai Han Palo Braised Goose (ç±³å…¶æ—æ»·éµ)", "Weekend Market (æ²³é‚Šå¸‚é›†)", "Pak Khlong Talad èŠ±å¸‚ (çµ‚é»)", "KHIRI Thai tea (èŠ±å¸‚é™„è¿‘)" ]
                },
                { time: "12:30 - 13:00", title: "åˆé¤: Nai Mong Hoi Tod", type: "food", icon: "utensils", location: "Nai Mong Hoi Tod Bangkok", desc: "ç±³å…¶æ—æ¨è–¦èšµä»”ç…ï¼Œé…¥è„†å£æ„Ÿã€‚" },
                { time: "14:00 - 14:30", title: "Ann Guay Tiew Kua Gai", type: "food", icon: "utensils", location: "Ann Guay Tiew Kua Gai Bangkok", desc: "ç±³å…¶æ—æ¨è–¦ç²¿æ¢è€åº— (é›è‚‰ç‚’æ²³ç²‰)ã€‚" },
                { time: "15:00 - 17:00", title: "Central World å•†åœˆ", type: "shopping", icon: "shopping", location: "Central World Bangkok", desc: "é€›è¡—è¡Œç¨‹ã€‚é‡é»ï¼šUno cafe, Mith é¦™æ°´ã€‚" },
                { time: "17:30 - 20:00", title: "Central Park / KAEW BOUTIQUE", type: "relax", icon: "coffee", location: "Kaew Boutique Bangkok", desc: "é¦™è˜­è‘‰ç”œé»å°ˆè³£åº—ï¼Œäº«å—å‚æ™šæ™‚å…‰ã€‚" },
                { time: "20:30 - 21:30", title: "æ™šé¤: CHONTHONG Kaprow", type: "food", icon: "utensils", location: "Chonthong Kaprow Silom", desc: "à¸Šà¹‰à¸­à¸™à¸—à¸­à¸‡ à¸•à¹‰à¸™à¸•à¸³à¸£à¸±à¸šà¸à¸°à¹€à¸à¸£à¸²à¹„à¸—à¸¢ (Silomåˆ†åº—) - æ­£å®—æ³°å¼æ‰“æ‹‹è±¬ã€‚" }
            ]
        };

        const checklistData = [
            { id: 0, text: "æ”œå¸¶ 5000 å°å¹£", sub: "ç¾é‡‘å‚™ç”¨" },
            { id: 1, text: "è­·ç…§", sub: "Passport" },
            { id: 2, text: "æ·±è‰²è¡£æœå‚™è‘—", sub: "é€²å¯ºå»Ÿ/æ­£å¼å ´åˆ" },
            { id: 3, text: "è¡Œå‹•é›»æº", sub: "Power Bank" },
            { id: 4, text: "å……é›»å™¨", sub: "Charger" },
            { id: 5, text: "æ²æµ´ç›¥æ´—ç”¨å“", sub: "Toiletries" }
        ];

        // --- åˆ†å¸³ç³»çµ±è³‡æ–™ ---
        // æ³¨æ„ï¼šv4 æ›´æ–°è³‡æ–™çµæ§‹ä»¥æ”¯æ´å¤šäººä»˜æ¬¾ (payers is array)
        // ç‚ºäº†ç›¸å®¹æ€§ï¼Œé€™è£¡æœƒè®€å–èˆŠè³‡æ–™ä¸¦å˜—è©¦é¡¯ç¤º
        let splitData = JSON.parse(localStorage.getItem('bangkok_trip_split_data_v4')) || {
            currency: 'THB',
            users: [],
            expenses: [] // { desc, amount, payers: ['A', 'B'] }
        };
        const currencySymbols = { 'THB': 'à¸¿', 'TWD': 'NT$', 'JPY': 'Â¥', 'KRW': 'â‚©', 'USD': '$', 'EUR': 'â‚¬' };
        
        // æš«å­˜é¸ä¸­çš„å¢Šä»˜äºº (æ–°å¢æ”¯å‡ºæ™‚ä½¿ç”¨)
        let selectedPayers = [];

        // --- SVG Icons ---
        const icons = {
            clock: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
            navigation: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>`,
            camera: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>`,
            utensils: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>`,
            coffee: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>`,
            shopping: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>`,
            music: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>`,
            moon: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`,
            mapPin: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
            alert: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,
            check: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
            arrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>`
        };

        // --- ç‹€æ…‹ç®¡ç† ---
        let currentDay = '11/29';
        let checkedItems = JSON.parse(localStorage.getItem('bangkok_trip_checklist_2025')) || {};

        function playSound() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    const audioCtx = new AudioContext();
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.15);
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.15);
                }
            } catch (e) { console.error("Audio not supported"); }
        }

        // --- è¡Œç¨‹æ¸²æŸ“é‚è¼¯ (èˆ‡èˆŠç‰ˆç›¸åŒ) ---
        function getTypeColor(type) {
            switch (type) {
                case 'food': return 'bg-orange-100 text-orange-700 border-orange-200';
                case 'culture': return 'bg-amber-100 text-amber-700 border-amber-200';
                case 'cafe': return 'bg-yellow-50 text-yellow-800 border-yellow-200';
                case 'nightlife': return 'bg-purple-100 text-purple-800 border-purple-200';
                case 'shopping': return 'bg-pink-50 text-pink-700 border-pink-200';
                default: return 'bg-teal-50 text-teal-800 border-teal-200';
            }
        }

        function renderItinerary() {
            const container = document.getElementById('itinerary-view');
            container.innerHTML = ''; 

            if (currentDay === 'split') return;

            const items = itineraryData[currentDay];
            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `group relative bg-white/90 backdrop-blur-sm rounded-xl p-6 shadow-md border-l-4 border-l-amber-500 border-y border-r border-amber-100 hover:shadow-2xl hover:border-l-purple-600 transition-all duration-300 transform hover:-translate-y-1 fade-in`;
                card.style.animationDelay = `${index * 0.05}s`;

                let subListHTML = '';
                if (item.subList) {
                    const listItems = item.subList.map(sub => 
                        `<li class="flex items-start gap-3 text-sm text-gray-700 font-sans"><span class="text-purple-600 mt-1">âœ¦</span>${sub}</li>`
                    ).join('');
                    subListHTML = `
                        <div class="bg-amber-50/50 rounded-lg p-4 mb-4 border border-amber-200 max-h-64 overflow-y-auto custom-scrollbar">
                            <p class="text-xs font-bold text-amber-800 mb-3 uppercase tracking-widest border-b border-amber-200 pb-1">Hidden Gems</p>
                            <ul class="space-y-3">${listItems}</ul>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="absolute -top-3 left-6">
                        <span class="bg-purple-900 text-amber-100 text-xs font-sans font-bold px-4 py-1.5 rounded-full shadow-md flex items-center gap-1 border border-amber-500">
                            ${icons.clock} ${item.time}
                        </span>
                    </div>
                    <div class="flex gap-4 pt-3">
                        <div class="flex-shrink-0 w-14 h-14 rounded-xl flex items-center justify-center shadow-inner ${getTypeColor(item.type)}">
                            ${icons[item.icon] || icons.mapPin}
                        </div>
                        <div class="flex-1">
                            <h3 class="font-serif font-bold text-xl text-gray-800 leading-tight mb-2 tracking-wide text-purple-950">${item.title}</h3>
                            ${item.desc ? `<p class="text-sm font-sans text-gray-600 mb-4 leading-relaxed">${item.desc}</p>` : ''}
                            ${subListHTML}
                        </div>
                    </div>
                    <div class="mt-2 pt-4 border-t border-dashed border-amber-200 flex justify-end">
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}" target="_blank" rel="noopener noreferrer" onclick="playSound()" class="flex items-center gap-2 bg-amber-100 hover:bg-amber-200 text-amber-900 px-5 py-2.5 rounded-lg text-sm font-bold transition-colors active:scale-95 no-underline shadow-sm border border-amber-200">
                            <span class="text-purple-700">${icons.navigation}</span>
                            <span class="font-sans">å°èˆª</span>
                        </a>
                    </div>
                `;
                container.appendChild(card);
            });

            if (currentDay === '11/30') {
                renderChecklist(container);
            }

            const endMarker = document.createElement('div');
            endMarker.className = "text-center py-10 opacity-60 fade-in";
            endMarker.style.animationDelay = "0.5s";
            endMarker.innerHTML = `
                <div class="flex items-center justify-center gap-2 mb-2">
                    <span class="h-px w-12 bg-amber-300"></span>
                    <span class="text-amber-500 text-xl">âœ¤</span>
                    <span class="h-px w-12 bg-amber-300"></span>
                </div>
                <p class="text-xs font-serif text-amber-800 tracking-widest">End of ${currentDay}</p>
            `;
            container.appendChild(endMarker);
        }

        function renderChecklist(container) {
            const checklistContainer = document.createElement('div');
            checklistContainer.className = "mt-8 bg-amber-100/80 rounded-xl p-6 border-2 border-amber-400 border-dashed relative overflow-hidden shadow-lg fade-in";
            
            const header = `
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-amber-300/50">
                    <div class="bg-purple-900 text-white p-2.5 rounded-full shadow-md">${icons.alert}</div>
                    <div>
                        <h3 class="font-serif font-bold text-2xl text-purple-900">é‡é»æé†’</h3>
                        <p class="text-xs font-sans text-amber-700 uppercase tracking-widest">Important Checklist</p>
                    </div>
                </div>
            `;

            const list = document.createElement('ul');
            list.className = "grid grid-cols-1 md:grid-cols-2 gap-4";

            checklistData.forEach(item => {
                const isChecked = checkedItems[item.id];
                const li = document.createElement('li');
                li.className = `flex items-center gap-3 p-3 rounded-lg border shadow-sm cursor-pointer transition-all duration-300 select-none scale-click ${
                    isChecked ? 'bg-green-50 border-green-200 shadow-inner' : 'bg-white/60 border-amber-200/50 hover:bg-white hover:shadow-md'
                }`;
                
                li.innerHTML = `
                    <div class="flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-300 ${
                        isChecked ? 'bg-green-500 border-green-500 scale-110' : 'bg-transparent border-gray-400'
                    }">
                        ${isChecked ? `<span class="text-white">${icons.check}</span>` : ''}
                    </div>
                    <div>
                        <span class="block font-bold font-serif text-lg transition-all duration-300 ${
                            isChecked ? 'text-green-800 line-through decoration-green-500/50 opacity-70' : 'text-amber-900'
                        }">${item.text}</span>
                        <span class="block text-xs font-sans transition-colors ${
                            isChecked ? 'text-green-600/70' : 'text-amber-600/80'
                        }">${item.sub}</span>
                    </div>
                `;

                li.onclick = () => {
                    playSound();
                    if (checkedItems[item.id]) {
                        delete checkedItems[item.id];
                    } else {
                        checkedItems[item.id] = true;
                    }
                    localStorage.setItem('bangkok_trip_checklist_2025', JSON.stringify(checkedItems));
                    updateListItemStyle(li, item.id);
                };
                list.appendChild(li);
            });

            checklistContainer.innerHTML = header;
            checklistContainer.appendChild(list);
            container.appendChild(checklistContainer);
        }

        function updateListItemStyle(element, id) {
            const isChecked = checkedItems[id];
            element.className = `flex items-center gap-3 p-3 rounded-lg border shadow-sm cursor-pointer transition-all duration-300 select-none scale-click ${
                isChecked ? 'bg-green-50 border-green-200 shadow-inner' : 'bg-white/60 border-amber-200/50 hover:bg-white hover:shadow-md'
            }`;
            const checkbox = element.querySelector('div:first-child');
            checkbox.className = `flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-300 ${
                isChecked ? 'bg-green-500 border-green-500 scale-110' : 'bg-transparent border-gray-400'
            }`;
            checkbox.innerHTML = isChecked ? `<span class="text-white">${icons.check}</span>` : '';
            const title = element.querySelector('span:nth-of-type(1)');
            title.className = `block font-bold font-serif text-lg transition-all duration-300 ${
                isChecked ? 'text-green-800 line-through decoration-green-500/50 opacity-70' : 'text-amber-900'
            }`;
            const sub = element.querySelector('span:nth-of-type(2)');
            sub.className = `block text-xs font-sans transition-colors ${
                isChecked ? 'text-green-600/70' : 'text-amber-600/80'
            }`;
        }

        function switchTab(day) {
            playSound();
            currentDay = day;
            
            const tabs = ['1129', '1130', 'split'];
            const activeClass = "bg-purple-900 border-amber-400 text-amber-100 shadow-lg shadow-purple-900/40 transform scale-105";
            const inactiveClass = "bg-white border-amber-100 text-amber-800 hover:bg-amber-100 hover:border-amber-300";

            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (!btn) return;
                const isSelected = (t === 'split' && day === 'split') || (t === '1129' && day === '11/29') || (t === '1130' && day === '11/30');
                let baseClass = "flex-1 py-2 px-3 rounded-xl font-serif font-bold text-base md:text-lg transition-all duration-300 border-2 whitespace-nowrap";
                if (t === 'split') baseClass += " flex items-center justify-center gap-1";
                btn.className = `${baseClass} ${isSelected ? activeClass : inactiveClass}`;
            });

            const itineraryView = document.getElementById('itinerary-view');
            const splitView = document.getElementById('split-view');

            if (day === 'split') {
                itineraryView.style.display = 'none';
                splitView.classList.remove('hidden');
                splitView.style.display = 'block';
                renderSplitView(); // åˆå§‹åŒ–åˆ†å¸³ç•«é¢
            } else {
                splitView.style.display = 'none';
                itineraryView.style.display = 'block';
                renderItinerary();
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- åˆ†å¸³ç³»çµ±é‚è¼¯ (v4: è¤‡é¸ä»˜æ¬¾äºº) ---

        function saveSplitData() {
            localStorage.setItem('bangkok_trip_split_data_v4', JSON.stringify(splitData));
            renderSplitView();
        }

        function renderSplitView() {
            // 1. åˆå§‹åŒ–å¹£åˆ¥
            document.getElementById('currency-select').value = splitData.currency;
            
            // 2. æ¸²æŸ“æˆå“¡åˆ—è¡¨
            const userList = document.getElementById('user-list');
            userList.innerHTML = splitData.users.map(u => 
                `<div class="flex items-center gap-1 bg-purple-100 text-purple-800 text-sm font-medium px-3 py-1 rounded-full border border-purple-200">
                    ${u}
                    <button onclick="removeUser('${u}')" class="ml-1 text-purple-400 hover:text-purple-600">Ã—</button>
                </div>`
            ).join('') || '<span class="text-gray-400 text-sm italic">å°šæœªæ–°å¢æˆå“¡</span>';

            // 3. æ¸²æŸ“ä»˜æ¬¾äººé¸å–® (æŒ‰éˆ•å½¢å¼ï¼Œæ”¯æ´è¤‡é¸)
            renderPayerSelection();

            // 4. æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨
            const expenseListBody = document.getElementById('expense-list-body');
            const symbol = currencySymbols[splitData.currency];
            let total = 0;
            
            if (splitData.expenses.length === 0) {
                expenseListBody.innerHTML = `<tr class="bg-white border-b"><td colspan="4" class="px-3 py-4 text-center text-gray-400">ç›®å‰æ²’æœ‰æ”¯å‡ºç´€éŒ„</td></tr>`;
            } else {
                expenseListBody.innerHTML = splitData.expenses.map((exp, idx) => {
                    total += parseFloat(exp.amount);
                    // æª¢æŸ¥ payer æ˜¯å­—ä¸²é‚„æ˜¯é™£åˆ— (ç›¸å®¹èˆŠç‰ˆ)
                    let payersDisplay = Array.isArray(exp.payers) ? exp.payers.join(', ') : (exp.payer || '?');
                    
                    return `
                    <tr class="bg-white border-b hover:bg-amber-50/50 transition-colors">
                        <td class="px-3 py-3 font-medium text-gray-900">${exp.desc}</td>
                        <td class="px-3 py-3">${payersDisplay}</td>
                        <td class="px-3 py-3 font-mono">${symbol} ${exp.amount}</td>
                        <td class="px-3 py-3 text-right">
                            <button onclick="removeExpense(${idx})" class="text-red-400 hover:text-red-600 p-1 hover:bg-red-50 rounded transition-colors">${icons.trash}</button>
                        </td>
                    </tr>`;
                }).join('');
            }
            document.getElementById('total-amount-display').innerText = `ç¸½è¨ˆ: ${symbol} ${total}`;

            // 5. è¨ˆç®—ä¸¦æ¸²æŸ“çµç®—çµæœ
            calculateSettlement();
        }

        // æ–°å¢ï¼šæ¸²æŸ“ä»˜æ¬¾äººé¸å–æŒ‰éˆ•
        function renderPayerSelection() {
            const container = document.getElementById('payer-selection-container');
            if (splitData.users.length === 0) {
                container.innerHTML = '<span class="text-gray-400 text-sm py-1">è«‹å…ˆæ–°å¢æˆå“¡</span>';
                return;
            }
            
            container.innerHTML = splitData.users.map(u => {
                const isSelected = selectedPayers.includes(u);
                return `
                <button onclick="togglePayer('${u}')" class="px-4 py-2 rounded-full text-sm font-bold transition-all duration-200 border border-transparent shadow-sm scale-click ${
                    isSelected 
                    ? 'bg-amber-500 text-white shadow-amber-500/30' 
                    : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'
                }">
                    ${u}
                </button>`;
            }).join('');
        }

        function togglePayer(name) {
            playSound();
            if (selectedPayers.includes(name)) {
                selectedPayers = selectedPayers.filter(p => p !== name);
            } else {
                selectedPayers.push(name);
            }
            renderPayerSelection();
        }

        function updateCurrency() {
            const select = document.getElementById('currency-select');
            splitData.currency = select.value;
            saveSplitData();
        }

        function addUser() {
            const input = document.getElementById('new-user-input');
            const name = input.value.trim();
            if (name && !splitData.users.includes(name)) {
                splitData.users.push(name);
                input.value = '';
                saveSplitData();
                playSound();
            } else if (splitData.users.includes(name)) {
                alert('æˆå“¡å·²å­˜åœ¨');
            }
        }

        function removeUser(name) {
            // æª¢æŸ¥æ”¯å‡ºç´€éŒ„
            const hasExpense = splitData.expenses.some(e => {
                if (Array.isArray(e.payers)) return e.payers.includes(name);
                return e.payer === name;
            });
            
            if (hasExpense) {
                if(!confirm(`æˆå“¡ ${name} æœ‰æ”¯å‡ºç´€éŒ„ï¼Œåˆªé™¤å°‡æœƒç§»é™¤ç›¸é—œå¸³ç›®ï¼Œç¢ºå®šå—ï¼Ÿ`)) return;
                splitData.expenses = splitData.expenses.filter(e => {
                     if (Array.isArray(e.payers)) return !e.payers.includes(name);
                     return e.payer !== name;
                });
            }
            splitData.users = splitData.users.filter(u => u !== name);
            // æ¸…ç†æš«å­˜é¸å–
            selectedPayers = selectedPayers.filter(u => u !== name);
            
            saveSplitData();
        }

        function addExpense() {
            const desc = document.getElementById('expense-desc').value.trim();
            const amount = parseFloat(document.getElementById('expense-amount').value);

            if (!desc || isNaN(amount)) {
                alert('è«‹å®Œæ•´å¡«å¯«é …ç›®èˆ‡é‡‘é¡');
                return;
            }
            if (selectedPayers.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€ä½ä»˜æ¬¾äºº');
                return;
            }

            // v4 çµæ§‹: desc, amount, payers (array)
            splitData.expenses.push({ 
                desc, 
                amount, 
                payers: [...selectedPayers] // è¤‡è£½é™£åˆ—
            });
            
            // æ¸…ç©ºè¼¸å…¥èˆ‡é¸å–
            document.getElementById('expense-desc').value = '';
            document.getElementById('expense-amount').value = '';
            selectedPayers = [];
            
            saveSplitData();
            playSound();
        }

        function removeExpense(index) {
            splitData.expenses.splice(index, 1);
            saveSplitData();
        }

        function calculateSettlement() {
            const container = document.getElementById('settlement-result');
            const users = splitData.users;
            const expenses = splitData.expenses;
            const symbol = currencySymbols[splitData.currency];

            if (users.length < 2 || expenses.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-4">è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•çµç®—</div>';
                return;
            }

            // 1. è¨ˆç®—æ¯äººé¤˜é¡ (æ­£ = æ‡‰æ”¶, è²  = æ‡‰ä»˜)
            let balances = {};
            users.forEach(u => balances[u] = 0);
            
            let totalSpent = 0;
            expenses.forEach(e => {
                const amt = parseFloat(e.amount);
                totalSpent += amt;
                
                // è™•ç†ä»˜æ¬¾äºº (å¤šäººå¹³åˆ†å¢Šä»˜é¡)
                const payersList = Array.isArray(e.payers) ? e.payers : [e.payer];
                const amountPerPayer = amt / payersList.length;
                
                payersList.forEach(p => {
                    if (balances[p] !== undefined) {
                        balances[p] += amountPerPayer;
                    }
                });
            });

            // æ‰€æœ‰äººå¹³å‡åˆ†æ”¤ç¸½æ¶ˆè²»
            const average = totalSpent / users.length;
            users.forEach(u => balances[u] -= average);

            // 2. åˆ†é¡å‚µå‹™äººèˆ‡å‚µæ¬Šäºº
            let debtors = [];
            let creditors = [];
            users.forEach(u => {
                const b = balances[u];
                if (b < -0.01) debtors.push({ name: u, amount: b }); // æ¬ éŒ¢
                if (b > 0.01) creditors.push({ name: u, amount: b }); // è¢«æ¬ éŒ¢
            });

            debtors.sort((a, b) => a.amount - b.amount); // æ¬ æœ€å¤šæ’å‰é¢
            creditors.sort((a, b) => b.amount - a.amount); // å€Ÿæœ€å¤šæ’å‰é¢

            // 3. é…å°çµç®—
            let results = [];
            let i = 0; 
            let j = 0; 

            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];
                
                // å–å…©è€…çµ•å°å€¼è¼ƒå°è€…ç‚ºäº¤æ˜“é‡‘é¡
                let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                
                results.push({
                    from: debtor.name,
                    to: creditor.name,
                    amount: amount
                });

                // æ›´æ–°é¤˜é¡
                debtor.amount += amount;
                creditor.amount -= amount;

                if (Math.abs(debtor.amount) < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }

            // 4. æ¸²æŸ“çµæœ
            if (results.length === 0) {
                container.innerHTML = '<div class="text-center text-green-600 font-bold py-4">å¸³ç›®å·²å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³ï¼</div>';
            } else {
                container.innerHTML = results.map(r => `
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border-l-4 border-green-400">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">${r.from}</span>
                            <span class="text-gray-400 text-xs">${icons.arrowRight}</span>
                            <span class="font-bold text-gray-800">${r.to}</span>
                        </div>
                        <div class="font-bold text-green-600 font-mono">
                            ${symbol} ${r.amount.toFixed(2)}
                        </div>
                    </div>
                `).join('');
            }
        }

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            renderItinerary();
        };

    </script>
</body>
</html>

